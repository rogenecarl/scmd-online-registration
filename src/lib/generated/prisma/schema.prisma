// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// ENUMS
// ==========================================

enum UserRole {
  USER
  ADMIN
  PRESIDENT
}

enum Gender {
  MALE
  FEMALE
}

enum EventStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==========================================
// AUTH MODELS (Better Auth)
// ==========================================

model User {
  id            String   @id @default(uuid())
  name          String
  email         String
  role          UserRole @default(USER)
  emailVerified Boolean  @default(false)
  image         String?
  churchId      String?  @map("church_id")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  sessions              Session[]
  accounts              Account[]
  church                Church?        @relation("ChurchPresidents", fields: [churchId], references: [id])
  registrations         Registration[]
  reviewedRegistrations Registration[] @relation("RegistrationReviewer")

  @@unique([email])
  @@index([churchId])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@index([expiresAt])
  @@map("verification")
}

// ==========================================
// ORGANIZATIONAL MODELS
// ==========================================

model Division {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  churches    Church[]
  coordinator Coordinator?

  @@map("division")
}

model Church {
  id         String   @id @default(cuid())
  name       String   @unique
  divisionId String   @map("division_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  division      Division       @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  pastor        Pastor?
  presidents    User[]         @relation("ChurchPresidents")
  registrations Registration[]

  @@index([divisionId])
  @@map("church")
}

model Coordinator {
  id         String   @id @default(cuid())
  name       String
  divisionId String   @unique @map("division_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations (1 coordinator per division)
  division Division @relation(fields: [divisionId], references: [id], onDelete: Cascade)

  @@map("coordinator")
}

model Pastor {
  id        String   @id @default(cuid())
  name      String
  churchId  String   @unique @map("church_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations (1 pastor per church)
  church Church @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@map("pastor")
}

// ==========================================
// EVENT & REGISTRATION MODELS
// ==========================================

model Event {
  id                   String   @id @default(cuid())
  name                 String
  description          String?  @db.Text
  location             String
  logo                 String?
  startDate            DateTime @map("start_date")
  endDate              DateTime @map("end_date")
  registrationDeadline DateTime @map("registration_deadline")

  // Pre-registration period (fees in Philippine Peso - whole numbers)
  preRegistrationFee   Int      @map("pre_registration_fee")
  preRegistrationStart DateTime @map("pre_registration_start")
  preRegistrationEnd   DateTime @map("pre_registration_end")

  // On-site & Cook registration fees (in Philippine Peso - whole numbers)
  onsiteRegistrationFee Int @map("onsite_registration_fee")
  cookRegistrationFee   Int @map("cook_registration_fee")

  status    EventStatus @default(UPCOMING)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  // Relations
  registrations Registration[]

  @@index([status])
  @@index([startDate])
  @@map("event")
}

model Registration {
  id          String             @id @default(cuid())
  eventId     String             @map("event_id")
  churchId    String             @map("church_id")
  presidentId String             @map("president_id")
  status      RegistrationStatus @default(PENDING)
  remarks     String?            @db.Text
  reviewedAt  DateTime?          @map("reviewed_at")
  reviewedBy  String?            @map("reviewed_by")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  // Fee tracking (captured at registration time)
  totalFee             Int     @default(0) @map("total_fee")
  delegateFeePerPerson Int     @default(0) @map("delegate_fee_per_person")
  cookFeePerPerson     Int     @default(0) @map("cook_fee_per_person")
  isPreRegistration    Boolean @default(false) @map("is_pre_registration")

  // Relations
  event     Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  church    Church     @relation(fields: [churchId], references: [id], onDelete: Cascade)
  president User       @relation(fields: [presidentId], references: [id], onDelete: Cascade)
  reviewer  User?      @relation("RegistrationReviewer", fields: [reviewedBy], references: [id])
  delegates Delegate[]
  cooks     Cook[]

  // Unique constraint: One registration per church per event
  @@unique([eventId, churchId])
  @@index([eventId])
  @@index([churchId])
  @@index([presidentId])
  @@index([status])
  @@map("registration")
}

model Delegate {
  id             String   @id @default(cuid())
  fullName       String   @map("full_name")
  nickname       String?
  age            Int
  gender         Gender
  registrationId String   @map("registration_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  registration Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  @@index([registrationId])
  @@map("delegate")
}

model Cook {
  id             String   @id @default(cuid())
  fullName       String   @map("full_name")
  nickname       String?
  age            Int
  gender         Gender
  registrationId String   @map("registration_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  registration Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  @@index([registrationId])
  @@map("cook")
}
