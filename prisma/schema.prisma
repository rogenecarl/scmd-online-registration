// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// ENUMS
// ==========================================

enum UserRole {
  USER
  ADMIN
  PRESIDENT
}

enum Gender {
  MALE
  FEMALE
}

enum EventStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==========================================
// AUTH MODELS (Better Auth)
// ==========================================

model User {
  id            String    @id @default(uuid())
  name          String
  email         String
  role          UserRole  @default(USER)
  emailVerified Boolean   @default(false)
  image         String?
  churchId      String?   @map("church_id")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sessions       Session[]
  accounts       Account[]
  church         Church?             @relation("ChurchPresidents", fields: [churchId], references: [id])
  registrations  Registration[]
  reviewedBatches RegistrationBatch[] @relation("BatchReviewer")

  @@unique([email])
  @@index([churchId])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@index([expiresAt])
  @@map("verification")
}

// ==========================================
// ORGANIZATIONAL MODELS
// ==========================================

model Division {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  churches    Church[]
  coordinator Coordinator?

  @@map("division")
}

model Church {
  id         String   @id @default(cuid())
  name       String   @unique
  divisionId String   @map("division_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  division      Division       @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  pastor        Pastor?
  presidents    User[]         @relation("ChurchPresidents")
  registrations Registration[]

  @@index([divisionId])
  @@map("church")
}

model Coordinator {
  id         String   @id @default(cuid())
  name       String
  divisionId String   @unique @map("division_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations (1 coordinator per division)
  division Division @relation(fields: [divisionId], references: [id], onDelete: Cascade)

  @@map("coordinator")
}

model Pastor {
  id        String   @id @default(cuid())
  name      String
  churchId  String   @unique @map("church_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations (1 pastor per church)
  church Church @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@map("pastor")
}

// ==========================================
// EVENT & REGISTRATION MODELS
// ==========================================

model Event {
  id                   String      @id @default(cuid())
  name                 String
  description          String?     @db.Text
  location             String
  banner               String?     // Banner image URL from Supabase Storage
  startDate            DateTime    @map("start_date")
  endDate              DateTime    @map("end_date")

  // Pre-registration period (fees in Philippine Peso - whole numbers)
  preRegistrationFee            Int         @map("pre_registration_fee")
  preRegistrationSiblingDiscount Int        @default(0) @map("pre_registration_sibling_discount") // Discounted fee for 3+ siblings
  preRegistrationStart          DateTime    @map("pre_registration_start")
  preRegistrationEnd            DateTime    @map("pre_registration_end")

  // On-site & Cook registration fees (in Philippine Peso - whole numbers)
  onsiteRegistrationFee    Int        @map("onsite_registration_fee")
  onsiteSiblingDiscount    Int        @default(0) @map("onsite_sibling_discount") // Discounted fee for 3+ siblings
  cookRegistrationFee      Int        @map("cook_registration_fee")

  status    EventStatus @default(UPCOMING)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  // Relations
  registrations Registration[]

  @@index([status])
  @@index([startDate])
  @@map("event")
}

// Registration is now a lightweight container for church+event
// All delegates/cooks are organized into batches
model Registration {
  id          String   @id @default(cuid())
  eventId     String   @map("event_id")
  churchId    String   @map("church_id")
  presidentId String   @map("president_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  event     Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  church    Church              @relation(fields: [churchId], references: [id], onDelete: Cascade)
  president User                @relation(fields: [presidentId], references: [id], onDelete: Cascade)
  batches   RegistrationBatch[]

  // Unique constraint: One registration per church per event
  @@unique([eventId, churchId])
  @@index([eventId])
  @@index([churchId])
  @@index([presidentId])
  @@map("registration")
}

// Each batch is independently approved
// Presidents can submit multiple batches, each with its own status
model RegistrationBatch {
  id             String             @id @default(cuid())
  registrationId String             @map("registration_id")
  batchNumber    Int                @map("batch_number") // Sequential batch number (1, 2, 3...)
  status         RegistrationStatus @default(PENDING)
  remarks        String?            @db.Text
  receiptImage   String?            @map("receipt_image") // Payment receipt image URL
  reviewedAt     DateTime?          @map("reviewed_at")
  reviewedBy     String?            @map("reviewed_by")
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  // Fee tracking (captured at batch submission time)
  totalFee             Int     @default(0) @map("total_fee")
  delegateFeePerPerson Int     @default(0) @map("delegate_fee_per_person")
  cookFeePerPerson     Int     @default(0) @map("cook_fee_per_person")
  isPreRegistration    Boolean @default(false) @map("is_pre_registration")

  // Relations
  registration Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  reviewer     User?        @relation("BatchReviewer", fields: [reviewedBy], references: [id])
  delegates    Delegate[]
  cooks        Cook[]

  @@index([registrationId])
  @@index([status])
  @@map("registration_batch")
}

model Delegate {
  id        String   @id @default(cuid())
  fullName  String   @map("full_name")
  nickname  String?
  age       Int
  gender    Gender
  isSibling Boolean  @default(false) @map("is_sibling") // Part of sibling group (3+ gets discount)
  batchId   String   @map("batch_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  batch RegistrationBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@map("delegate")
}

model Cook {
  id        String   @id @default(cuid())
  fullName  String   @map("full_name")
  nickname  String?
  age       Int
  gender    Gender
  batchId   String   @map("batch_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  batch RegistrationBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@map("cook")
}
